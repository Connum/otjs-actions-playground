name: Run Unicode Test Suite

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      PUSH_TO_MAIN: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
      COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
      SHORT_COMMIT_SHA: ${{ github.event.pull_request.head.sha | slice(0, 7) }}

    steps:
      
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup node
      uses: actions/setup-node@v4

    - name: Setup ninja
      uses: seanmiddleditch/gha-setup-ninja@master

    - name: Clone text-rendering-tests repository
      run: |
        git clone https://github.com/unicode-org/text-rendering-tests.git

    - name: Ensure reports directory exists
      run: mkdir -p reports

    # for speeding up the workflow when debugging this action
    - name: Delete HTML files in testcases directory
      run: |
        find text-rendering-tests/testcases -name '*.html' -not -name 'index.html' -delete
      
    - name: Run check.py script
      run: |
        cd text-rendering-tests
        python check.py --engine=OpenType.js --output="../reports/${{ env.COMMIT_SHA }}.html"
        if [[ "$PUSH_TO_MAIN" == "true" ]]; then
          # For pushes (merges to master)
          # Placeholder comment for later action
          echo "Generated HTML for merges to master. Commit logic will be added later."
        fi
            
    - name: Replace version with commit hash and link to PR commit
      run: |
        sed -i -E "s@OpenType\.js(\xC2\xA0| )[0-9.]+@<a href=\"https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/commits/${{ env.COMMIT_SHA }}\">OpenType.js ${{ env.SHORT_COMMIT_SHA }}</a>@" reports/${{ env.COMMIT_SHA }}.html

    - name: Upload build artifact
      if: ${{ env.PUSH_TO_MAIN == 'false' }}
      uses: actions/upload-artifact@v3
      with:
        name: unicode-text-rendering-report_${{ env.SHORT_COMMIT_SHA }}
        path: reports/${{ env.COMMIT_SHA }}.html
